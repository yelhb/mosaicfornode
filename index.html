<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Mosaic For Node.js</title>
    <link href="css/style.css" rel="stylesheet" type="text/css"/>	
    <script src="js/jquery.js"></script>
    <script src="js/CSInterface.js"></script>
    <script src="js/IMSInterface.js"></script>
    <script>
		function assetInfo(p_asset, p_value) {
			var assetID = p_asset;
			var value = p_value;
		}
	
		var cc_url = 'https://creative.adobe.com/api/v1/';
		var token_type = 'Bearer';
		var fs = require('fs');
		var CSLibrary = null;
		var IMSLibrary = null;
		var tmpFolderPath = null;
		var access_token = null;
		var assetsList = new Array();
		
		$(document).ready(function() {
			init();
			main();
        });
		
		/**
		 *	Functions for maintaining state of the extension
		 */
		function init() {
			
			// bind to the form's submit action
			$('#loginForm').submit(function() {
				var url = 'https://ims-na1-stg1.adobelogin.com/ims/login/v1/token?';
				var formParameters = $('#loginForm').formSerialize();
				
				login(url, formParameters, function(success) {
					if (success == true) {
						main();
					} else {
						alert("not logged in");
					}
				});
				
				// stop the page reloading
				return false;
			});
			
			CSLibrary = new CSInterface();
			IMSLibrary = new IMSInterface();
			
			fs.open(getTmpFolderPath() + 'assetsInfo.txt', 'w', function(err, fd) {
				if (err) {
					error_msg(err);
				}
				fs.closeSync(fd);
			});
		}
		
		function main() {
			login("", "", function(success) {
				if (success == true) {
					console.log('----->>> Start to load files. <<<----- main() -----');
					loadFiles();
					//prepareCandidate();
				} else {
					// TODO showAAM
					console.log('Haven\'t Login, should show AAM.');
				}
			});
		}
		
		// TODO (jtam): login failure does not trigger the onComplete callback
		// TODO (jtam): what's the best way to hide the client secret in a html page?
		function login(url, formParameters, onComplete) {
			var imsRef = null;
			var curAccountGUID = null;
			var curScope = "openid,creative_cloud";
			var curClientID = "CEP1";
			var curClientSecret = "6e273fc1-8d01-4eb8-96c7-cf2c7f0182c8";
			var detailsDes = "";
				
			// IMSConnect
			imsRef = IMSLibrary.imsConnect();
			
			// IMSFetchAccounts
			var accounts = IMSLibrary.imsFetchAccounts(imsRef, curClientID);
			$(accounts).find("UserID").each(function() {
				curAccountGUID = $(this).text();
			});
			
			// IMSFetchAccessToken
			IMSLibrary.addEventListener("com.adobe.csxs.events.internal.ims.FetchAccessToken", function (event) {
				var details = event.data;
				for (var i in details) {
					if (i == "access_token") {
						access_token = details[i];
						onComplete(true);
					}
				}
				
				IMSLibrary.removeEventListener("com.adobe.csxs.events.internal.ims.FetchAccessToken", this);
			});
			
			IMSLibrary.imsFetchAccessToken(imsRef, curClientID, curClientSecret, curAccountGUID, "", curScope);
		}
		
		// Takes an asset id and returns an <img> tag (the src property is injected at a later stage)
		function generateImgTag(id) {
			img_html = '\<img class=\'asset\' id=\'asset-' + id + '\'>\</img>';
			// alert(img_html);
			return img_html;
		}
		
		/**
		 * Load Files form creative Cloud.
		 * @see Get Collections API: https://stage.adobecc.com/developer/Resources/api/collections/GET.html
		 */
		function loadFiles() {
			var collectionUrl = 'collections/';	
			console.log('----->>> collectionUrl : ' + collectionUrl + '<<<----- loadFiles() -----');
			
			$.ajax({
				method: "GET",
				url: cc_url + collectionUrl,
				dataType: 'json',
				data: null,
				headers: {
					"Authorization" : token_type + ' ' + access_token
				},
				success: function(collections) {
					console.log('----->>> Get collections successfully <<<----- loadFiles() -----');
					for (var i = 0; i < collections.length; ++i ) {
						// All user's files in root collection whose name is null;
						// Caution: under this collection, folder and files will be mixed.
						if ("" == (collections[i])['name'] || null == (collections[i])['name']) {
							var collectionID = (collections[i])['url'].substring((collections[i])['url'].lastIndexOf('/') + 1);
							retrieveCollection(collectionID);
						}
					}
				},
				error: function(xhr, errStatus, errDesc) {
					alert("error");
					alert(errStatus + ": " + errDesc);
				}
			});
		}
		
		/**
		 * Retrieve Collection by collectionID.
		 * @see Get Collection by ID API: https://stage.adobecc.com/developer/Resources/api/collections/%7Bcollection-id%7D/GET.html
		 */
		function retrieveCollection(collectionID) {
			
			var collectionUrl = "collections/" + collectionID;
			$.ajax({
				method: "GET",
				url: cc_url + collectionUrl,
				dataType: 'json',
				data: null,
				headers: {
					"Authorization" : token_type + ' ' + access_token
				},
				success: function(collection){
					console.log('----->>> Get Collection successfully <<<----- retrieveCollection() -----');
					console.log('assets -->>>' + collection['members']);
					for (var itm in collection['members']) {
						console.log(itm + ' ----- ' + (collection['members'])[itm]);
						var assetID = ((collection['members'])[itm])['id'].substring(((collection['members'])[itm])['id'].lastIndexOf('/') + 1);
						fetchAsset(assetID);
					}
				},
				error: function(xhr, errStatus, errDesc) {
					alert("error");
					alert(errStatus + ": " + errDesc);
				}
			});
		}
		
		/**
		 * Fetch Asset by assetID.
		 * TODO : fetch thumbnails instead of full-size images
		 * @see Get Asset API: https://stage.adobecc.com/developer/Resources/api/assets/%7Basset-id%7D/GET.html
		 */
		function fetchAsset(assetID) {
			
			var url = cc_url + "assets/" + assetID;
			console.log('----->>> asset URL : ' + url + ' <<<----- fetchAsset() -----');
			var xhr = new XMLHttpRequest();
			xhr.open('GET', url, true);
			try{
				xhr.responseType = 'arraybuffer';
			} catch(e) {
				error_msg("unknown response type");
			}
			
			xhr.setRequestHeader('Authorization', token_type + ' ' + access_token);
			xhr.onload = function(e) {
				if (this.status == 200 || this.status == 304) {
					var uInt8Array = new Uint8Array(this.response);
					var i = uInt8Array.length;
					var binaryString = new Array(i);
					while (i--) {
						binaryString[i] = String.fromCharCode(uInt8Array[i]);
					}
					
					var data = binaryString.join('');
					var base64 = window.btoa(data);
					var img_tag = generateImgTag(assetID);
					document.getElementById('content').innerHTML = 
						document.getElementById('content').innerHTML + img_tag;
					document.getElementById('asset-' + assetID).src = 'data:image/png;base64,' + base64;
					
					// compute each img
					var imgInfo = new Image();
					imgInfo.src = 'data:image/png;base64,' + base64;
					imgInfo.onload = function() {
						document.getElementById('can').width = imgInfo.width;
						document.getElementById('can').height = imgInfo.height;
						var context = document.getElementById('can').getContext('2d');
						context.drawImage(imgInfo, 0, 0, imgInfo.width, imgInfo.height, 0 , 0, imgInfo.width, imgInfo.height);
						var imgData = context.getImageData(0, 0, imgInfo.width, imgInfo.height);
						var index = imgInfo.height * imgInfo.width;
						var sum = 0;
						var ave = 0;
						
						// compute average value without alpha
						for (var i = 0; i < index * 4; ++i) {
							sum += imgData.data[i];
							sum += imgData.data[i + 1];
							sum += imgData.data[i + 2];
							i += 3;
						}
						ave = sum / (index * 3);
						assetsList.push(new assetInfo(assetID, ave));
						console.log('assetID : ' + assetID + ' ave = ' + ave + ' assetsList.length :' + assetsList.length);
						writeAssetsInfo(assetID + ':' + ave + '\n');
					}
					
					$(".asset").click(function() {
						openFileInPS(this.id);
					});
					
					var result = window.cep.fs.writeFile(getTmpFolderPath() + 'asset-' + assetID + '.jpg', base64, cep.encoding.Base64);
					if (result.err != 0) {
						error_msg(result.err);
					}
				}
			};
			
			xhr.send();
		}
		
		// TODO (jtam): maybe we should create a new empty document and import the image as opposed to opening the image directly
		// such that the user is forced to save their image as a new document
		function openFileInPS(assetID) {
			var script = "app.open(File(\'" + getTmpFolderPath() + assetID + '.jpg' + "\'));";
			
			script += 'if (app.preferences.rulerUnits !== Units.PIXELS) { 									\n\
							app.preferences.rulerUnits = Units.PIXELS; 											\n\
						} 																							\n\
																													\n\
						var assetsList = new Array();															\n\
						var docRef = app.activeDocument;															\n\
						var docWidth = docRef.width;																\n\
						var docHeight = docRef.height;															\n\
						var divides = 4;																			\n\
						var gutter = 0;																			\n\
						var slotWidth = Math.floor(docWidth / divides);										\n\
						var slotHeight = Math.floor(docHeight / divides);										\n\
						var layerRef = docRef.activeLayer;														\n\
						var x, y;																					\n\
																													\n\
						docWidth = slotWidth * divides + gutter * (divides - 1);								\n\
						docHeight = slotHeight * divides + gutter * (divides - 1);							\n\
						docRef.resizeImage(docWidth, docHeight);												\n\
																													\n\
						function AssetInfo(p_assetID, p_value) {												\n\
							this.assetID = p_assetID;																\n\
							this.value = p_value;																	\n\
						}																							\n\
																													\n\
						function getSimilarImage(value, threshold) {											\n\
							for (var i = 0; i < assetsList.length; ++i) {										\n\
								if (Math.abs(assetsList[i].value - value) <= threshold) {						\n\
									return assetsList[i].assetID;												\n\
								}																					\n\
							}																						\n\
							var randomID = Math.floor((Math.random() * assetsList.length));					\n\
							return assetsList[randomID].assetID;												\n\
						}																							\n\
																													\n\
						app.documents.add(slotWidth, slotHeight, 72, \'tmp\');									\n\
						var tmpDoc = app.documents.getByName(\'tmp\');											\n\
						var fhandle = new File(\'' + getTmpFolderPath() + 'assetsInfo.txt\');					\n\
																													\n\
						fhandle.open("r");																		\n\
																													\n\
						while (!fhandle.eof) {																	\n\
							var line = fhandle.readln();															\n\
							var splitLine = line.split(":")														\n\
							if ("asset-" + splitLine[0] != \'' + assetID + '\') {								\n\
								assetsList.push(new AssetInfo(splitLine[0], splitLine[1]));					\n\
							}																						\n\
						}																							\n\
																													\n\
						for (y = docHeight; y > 0; y -= slotHeight) {											\n\
							for (x = docWidth; x > 0; x -= slotWidth) {											\n\
								app.activeDocument = docRef;														\n\
								docRef.activeLayer = layerRef;													\n\
								docRef.selection.select([															\n\
									[x - slotWidth, y - slotHeight],												\n\
									[x, y - slotHeight],															\n\
									[x, y],																			\n\
									[x - slotWidth, y]															\n\
								], SelectionType.REPLACE, 0, false);											\n\
								docRef.selection.copy();															\n\
								app.activeDocument = tmpDoc;														\n\
								tmpDoc.paste();																	\n\
																													\n\
								var rList = tmpDoc.channels.getByName("Red")["histogram"];					\n\
								var gList = tmpDoc.channels.getByName("Green")["histogram"];					\n\
								var bList = tmpDoc.channels.getByName("Blue")["histogram"];					\n\
								var sum = 0;																		\n\
								for (var i = 0; i <= 255; ++i) {													\n\
									sum += ((rList[i] * i) + (gList[i] * i) + (bList[i] * i));				\n\
								}																					\n\
								var ave = sum / (slotWidth * slotHeight * 3);									\n\
								var tmpID = getSimilarImage(ave, 5);											\n\
																													\n\
								app.open(File(\'' + getTmpFolderPath() + 'asset-\'+ tmpID + \'.jpg\'));		\n\
								var tmpDocRef = app.activeDocument;												\n\
								tmpDocRef.resizeImage(slotWidth, slotHeight);									\n\
								tmpDocRef.selection.select([														\n\
									[0, 0],																			\n\
									[tmpDocRef.width, 0],															\n\
									[tmpDocRef.width, tmpDocRef.height],										\n\
									[0, tmpDocRef.height]															\n\
								], SelectionType.EXTEND, 0, false);												\n\
								tmpDocRef.selection.copy();														\n\
								app.activeDocument = docRef;														\n\
								docRef.activeLayer = layerRef;													\n\
								docRef.artLayers.add();															\n\
								docRef.paste();																	\n\
								tmpDocRef.close(SaveOptions.DONOTSAVECHANGES);									\n\
								//tmpDoc.artLayers.removeAll();													\n\
								x -= gutter;																		\n\
							}																						\n\
							y -= gutter;																			\n\
						}																							\n\
						layerRef.remove();';
			console.log('----->>> script : ' +  script + ' <<<-----');
			CSLibrary.evalScript(script, function(result) {
				console.log('----->>> evalScript callback result : ' + result + ' <<<-----');
				if ("undefined" != result || result == EvalScript_ErrMessage ) {
					alert(result);
				}
				// TODO: check for failures
			});	
		}
			
		/**
		 * Traverse all files and compute their average value.
		 */
		function prepareCandidate() {
			var script;
			var dirPath = getTmpFolderPath();
			var m_directory = window.cep.fs.readdir(dirPath);
			
			if (!m_directory['err']) {
				var fileList = m_directory.data;
				for (var itm in fileList) {
					var fileState = window.cep.fs.stat(dirPath + fileList[itm]);
					if (!fileState.data.isDirectory()) {
						script = 'app.open(File(\'' + dirPath + fileList[itm] + '\'));';
						script += '															\
						if (app.preferences.rulerUnits !== Units.PIXELS) { 			\
							app.preferences.rulerUnits = Units.PIXELS; 					\
						} 																	\
						var docRef = app.activeDocument;									\
						var rList = docRef.channels.getByName("Red")["histogram"]; 	\
						var gList = docRef.channels.getByName("Green")["histogram"];	\
						var bList = docRef.channels.getByName("Blue")["histogram"];	\
						var sum = 0;														\
						for (var i = 0; i <= 255; ++i) {									\
							sum += ((rList[i] * i) + (gList[i] * i) + (bList[i] * i));\
						}																	\
						alert((docRef.width * docRef.height) + "aver : " + sum / (docRef.width * docRef.height * 3));	\
						//var ave = sum / (docRef.width * docRef.height);				\
						app.activeDocument.close();										\
						';
						console.log('----->>> Script: ' + script + ' <<<----- prepareCandidate()');
						CSLibrary.evalScript(script, function(result) {
							console.log('----->>> evalScript callback result : ' + result + script + ' <<<-----');
							if ("undefined" != result || result == EvalScript_ErrMessage ) {
								alert(result);
							}
							// TODO: check for failures
						});	
					}
				}
			}
		}
		
		/**
		 * Write assetsList to file. So that PS extendScript can read info.
		 */
		function writeAssetsInfo(info) {
			fs.open(getTmpFolderPath() + 'assetsInfo.txt', 'a+', function(err, fd) {
				if (err) {
					error_msg(err);
				}
				
				var buff = new Buffer(info);
				fs.write(fd, buff, 0, buff.length, null, function(err, written, buffer) {
					if (err) {
						error_msg(err);
					}
					console.log('----->>> written buffer Size:' + written + ' <<<----- writeAssetsInfo() ');
				});
				
				setTimeout(function() {
					fs.closeSync(fd);
				}, 1000);
			});
		}
		
		/**
		 * Functions for dealing with the file system
		 */
		function getTmpFolderPath() {
			if (tmpFolderPath == null) {
				tmpFolderPath = CSLibrary.getSystemPath(SystemPath.EXTENSION) + '/tmp/';
				createTmpFolder();
			}
			
			return tmpFolderPath;
		}
		
		function createTmpFolder() {
			if (tmpFolderPath != null) {
				window.cep.fs.makedir(tmpFolderPath);
			}
		}
		
		/**
		 * Utility functions
		 */
		function error_msg(errorMsg) {
			alert(errorMsg);
		}
    </script>
  </head>

  <body>
    <div id="container">
      <div id="content"></div>
    </div>
    <canvas id="can" style="border:1px solid #F7F2F2; display:none"></canvas>
  </body>
</html>
